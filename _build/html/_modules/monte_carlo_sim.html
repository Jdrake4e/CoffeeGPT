<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>monte_carlo_sim &#8212; CoffeeGPT 1.5.4 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/nature.css?v=0f882399" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <script src="../_static/documentation_options.js?v=1cd648e3"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CoffeeGPT 1.5.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">monte_carlo_sim</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for monte_carlo_sim</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">torch.nn</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span> <span class="c1"># type: ignore</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span> <span class="c1"># type: ignore</span>
<span class="kn">import</span> <span class="nn">sklearn</span> <span class="c1"># type: ignore</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span> <span class="c1"># type: ignore</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span> <span class="c1"># type: ignore</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span> <span class="c1"># type: ignore</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span> <span class="c1"># type: ignore</span>
<span class="kn">import</span> <span class="nn">matplotlib.dates</span> <span class="k">as</span> <span class="nn">mdates</span> <span class="c1"># type: ignore</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">cm</span> <span class="c1"># type: ignore</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>

<div class="viewcode-block" id="prediction_variance">
<a class="viewcode-back" href="../api_reference.html#monte_carlo_sim.prediction_variance">[docs]</a>
<span class="k">def</span> <span class="nf">prediction_variance</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">base_temp</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate rolling variance for recent predictions with safeguards for small windows.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    predictions : array-like</span>
<span class="sd">        Array of recent price predictions.</span>
<span class="sd">    window : int, default=5</span>
<span class="sd">        Size of the rolling window for variance calculation.</span>
<span class="sd">    base_temp : float, default=0.1</span>
<span class="sd">        Base temperature/variance to use when insufficient data is available.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Calculated variance scaled by base_temp, or default value if</span>
<span class="sd">        insufficient data is available.</span>
<span class="sd">        </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function is designed to provide adaptive variance estimation for</span>
<span class="sd">    Monte Carlo simulations. It handles edge cases like empty arrays or</span>
<span class="sd">    arrays smaller than the specified window by returning sensible defaults.</span>
<span class="sd">    </span>
<span class="sd">    The variance is scaled by base_temp to maintain appropriate noise levels</span>
<span class="sd">    in the simulation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">base_temp</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">window</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">base_temp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">base_temp</span>
    <span class="k">return</span> <span class="n">base_temp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="o">-</span><span class="n">window</span><span class="p">:])</span></div>


<div class="viewcode-block" id="calculate_dynamic_temperature">
<a class="viewcode-back" href="../api_reference.html#monte_carlo_sim.calculate_dynamic_temperature">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_dynamic_temperature</span><span class="p">(</span><span class="n">recent_predictions</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">base_temp</span><span class="p">,</span> <span class="n">decay_factor</span><span class="p">,</span> <span class="n">min_temp</span><span class="p">,</span> 
                                <span class="n">market_volatility_window</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">volatility_impact</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate dynamic temperature for Monte Carlo simulation based on recent market volatility.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    recent_predictions : list</span>
<span class="sd">        List of recent price predictions.</span>
<span class="sd">    day : int</span>
<span class="sd">        Current forecast day.</span>
<span class="sd">    base_temp : float</span>
<span class="sd">        Base temperature value.</span>
<span class="sd">    decay_factor : float</span>
<span class="sd">        Rate at which temperature decays over time (0-1).</span>
<span class="sd">    min_temp : float</span>
<span class="sd">        Minimum allowed temperature.</span>
<span class="sd">    market_volatility_window : int, default=5</span>
<span class="sd">        Number of recent predictions to consider for volatility.</span>
<span class="sd">    volatility_impact : float, default=0.2</span>
<span class="sd">        Scaling factor for how much volatility affects temperature.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Dynamic temperature value used for noise generation in simulations.</span>
<span class="sd">        </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function implements an adaptive approach to noise generation in Monte Carlo</span>
<span class="sd">    simulations by considering both time decay and market volatility. The temperature:</span>
<span class="sd">    </span>
<span class="sd">    1. Decays exponentially over time (forecast horizon)</span>
<span class="sd">    2. Increases with market volatility</span>
<span class="sd">    3. Has a guaranteed minimum value</span>
<span class="sd">    </span>
<span class="sd">    This approach helps maintain prediction diversity while adapting to changing</span>
<span class="sd">    market conditions and reducing noise as the forecast extends further into the future.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate base decayed temperature</span>
    <span class="n">decayed_temp</span> <span class="o">=</span> <span class="n">base_temp</span> <span class="o">*</span> <span class="p">(</span><span class="n">decay_factor</span> <span class="o">**</span> <span class="n">day</span><span class="p">)</span>
    
    <span class="c1"># Calculate volatility adjustment if enough history exists</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_predictions</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">market_volatility_window</span><span class="p">:</span>
        <span class="c1"># Calculate percentage changes</span>
        <span class="n">pct_changes</span> <span class="o">=</span>   <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">recent_predictions</span><span class="p">[</span><span class="o">-</span><span class="n">market_volatility_window</span><span class="p">:])</span> <span class="o">/</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">recent_predictions</span><span class="p">[</span><span class="o">-</span><span class="n">market_volatility_window</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="c1"># Use rolling volatility as a scaling factor</span>
        <span class="n">volatility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">pct_changes</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pct_changes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">volatility_adjustment</span> <span class="o">=</span> <span class="n">volatility</span> <span class="o">*</span> <span class="n">volatility_impact</span>
        
        <span class="c1"># Combine base temperature with volatility adjustment</span>
        <span class="n">dynamic_temp</span> <span class="o">=</span> <span class="n">decayed_temp</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">volatility_adjustment</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dynamic_temp</span> <span class="o">=</span> <span class="n">decayed_temp</span>
    
    <span class="c1"># Ensure temperature doesn&#39;t go below minimum</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">min_temp</span><span class="p">,</span> <span class="n">dynamic_temp</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_day_out_dict">
<a class="viewcode-back" href="../api_reference.html#monte_carlo_sim.create_day_out_dict">[docs]</a>
<span class="k">def</span> <span class="nf">create_day_out_dict</span><span class="p">(</span><span class="n">accuracy_plot_df</span><span class="p">,</span> <span class="n">y_test_filtered</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a dictionary of DataFrames where each DataFrame contains data for a specific day_out.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    accuracy_plot_df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing predictions.</span>
<span class="sd">    y_test_filtered : pandas.DataFrame</span>
<span class="sd">        DataFrame containing actual values.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary with day_out as keys and DataFrames as values.</span>
<span class="sd">        Each DataFrame contains merged prediction and actual data for a specific forecast horizon.</span>
<span class="sd">        </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function organizes backtesting results by forecast horizon (&#39;day_out&#39;),</span>
<span class="sd">    allowing for separate analysis of prediction accuracy at different time distances.</span>
<span class="sd">    The resulting dictionary enables detailed evaluation of how model performance</span>
<span class="sd">    changes as predictions extend further into the future.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get unique day_out values</span>
    <span class="n">unique_days</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">accuracy_plot_df</span><span class="p">[</span><span class="s1">&#39;day_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    
    <span class="c1"># Initialize dictionary</span>
    <span class="n">day_out_dict</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="c1"># Create DataFrame for each day_out</span>
    <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">unique_days</span><span class="p">:</span>
        <span class="c1"># Filter both DataFrames for the current day_out</span>
        <span class="n">predictions_mask</span> <span class="o">=</span> <span class="n">accuracy_plot_df</span><span class="p">[</span><span class="s1">&#39;day_out&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">day</span>
        <span class="n">actuals_mask</span> <span class="o">=</span> <span class="n">y_test_filtered</span><span class="p">[</span><span class="s1">&#39;day_out&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">day</span>
        
        <span class="c1"># Create combined DataFrame for this day_out</span>
        <span class="n">day_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;day_out&#39;</span><span class="p">:</span> <span class="n">day</span><span class="p">,</span>
            <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="n">accuracy_plot_df</span><span class="p">[</span><span class="n">predictions_mask</span><span class="p">][</span><span class="s1">&#39;means&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="s1">&#39;actual&#39;</span><span class="p">:</span> <span class="n">y_test_filtered</span><span class="p">[</span><span class="n">actuals_mask</span><span class="p">][</span><span class="s1">&#39;Price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="s1">&#39;start_idx&#39;</span><span class="p">:</span> <span class="n">accuracy_plot_df</span><span class="p">[</span><span class="n">predictions_mask</span><span class="p">][</span><span class="s1">&#39;start_idx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="s1">&#39;valid_idx&#39;</span><span class="p">:</span> <span class="n">accuracy_plot_df</span><span class="p">[</span><span class="n">predictions_mask</span><span class="p">][</span><span class="s1">&#39;valid_idx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="p">})</span>
        
        <span class="c1"># Store in dictionary</span>
        <span class="n">day_out_dict</span><span class="p">[</span><span class="n">day</span><span class="p">]</span> <span class="o">=</span> <span class="n">day_df</span>
    
    <span class="k">return</span> <span class="n">day_out_dict</span></div>


<div class="viewcode-block" id="MonteCarloForecaster">
<a class="viewcode-back" href="../api_reference.html#monte_carlo_sim.MonteCarloForecaster">[docs]</a>
<span class="k">class</span> <span class="nc">MonteCarloForecaster</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
        <span class="n">scaler</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="c1"># A sklearn scaler</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="n">sequence_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">base_temp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
        <span class="n">window_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Monte Carlo forecaster for time series prediction.</span>

<span class="sd">        This class implements Monte Carlo simulation methods for forecasting time series</span>
<span class="sd">        data, with support for adaptive noise generation, confidence intervals, and</span>
<span class="sd">        comprehensive visualization tools.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model : torch.nn.Module</span>
<span class="sd">            Trained PyTorch model for time series prediction.</span>
<span class="sd">        scaler : sklearn.preprocessing.StandardScaler</span>
<span class="sd">            Fitted scaler for inverse transforming predictions to original scale.</span>
<span class="sd">        device : torch.device</span>
<span class="sd">            Device to run computations on (CPU or CUDA).</span>
<span class="sd">        sequence_size : int</span>
<span class="sd">            Length of input sequences for the model.</span>
<span class="sd">        base_temp : float, default=0.01</span>
<span class="sd">            Base temperature for noise generation in Monte Carlo simulations.</span>
<span class="sd">        window_size : int, default=30</span>
<span class="sd">            Window size for calculating rolling variance in predictions.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        model : torch.nn.Module</span>
<span class="sd">            The trained model used for predictions.</span>
<span class="sd">        scaler : sklearn.preprocessing.StandardScaler</span>
<span class="sd">            Scaler for data transformation.</span>
<span class="sd">        device : torch.device</span>
<span class="sd">            Computation device.</span>
<span class="sd">        sequence_size : int</span>
<span class="sd">            Input sequence length.</span>
<span class="sd">        base_temp : float</span>
<span class="sd">            Base noise temperature.</span>
<span class="sd">        window_size : int</span>
<span class="sd">            Rolling window size.</span>
<span class="sd">        start_indices : numpy.ndarray or None</span>
<span class="sd">            Starting indices for backtesting.</span>
<span class="sd">        remaining_days_data : pandas.DataFrame or None</span>
<span class="sd">            Forecast data for future days.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Design Decisions:</span>
<span class="sd">        1. Model Handling:</span>
<span class="sd">           - Accepts any PyTorch module that processes sequences</span>
<span class="sd">           - Maintains model on specified device for efficient computation</span>
<span class="sd">           - Preserves model state during forecasting</span>
<span class="sd">        </span>
<span class="sd">        2. Data Processing:</span>
<span class="sd">           - Uses scaler for consistent data transformation</span>
<span class="sd">           - Maintains sequence size requirements</span>
<span class="sd">           - Handles both training and inference data formats</span>
<span class="sd">        </span>
<span class="sd">        3. Monte Carlo Parameters:</span>
<span class="sd">           - Configurable base temperature for noise generation</span>
<span class="sd">           - Adaptive window size for variance calculation</span>
<span class="sd">           - Flexible initialization for different use cases</span>
<span class="sd">        </span>
<span class="sd">        4. Memory Management:</span>
<span class="sd">           - Stores minimal state information</span>
<span class="sd">           - Uses efficient data structures for large simulations</span>
<span class="sd">           - Cleans up intermediate results automatically</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; import torch</span>
<span class="sd">        &gt;&gt;&gt; from sklearn.preprocessing import StandardScaler</span>
<span class="sd">        &gt;&gt;&gt; # Initialize with a trained model</span>
<span class="sd">        &gt;&gt;&gt; device = torch.device(&#39;cuda&#39; if torch.cuda.is_available() else &#39;cpu&#39;)</span>
<span class="sd">        &gt;&gt;&gt; forecaster = MonteCarloForecaster(</span>
<span class="sd">        ...     model=trained_model,</span>
<span class="sd">        ...     scaler=fitted_scaler,</span>
<span class="sd">        ...     device=device,</span>
<span class="sd">        ...     sequence_size=30</span>
<span class="sd">        ... )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">scaler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence_size</span> <span class="o">=</span> <span class="n">sequence_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_temp</span> <span class="o">=</span> <span class="n">base_temp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">=</span> <span class="n">window_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_indices</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remaining_days_data</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="MonteCarloForecaster.monte_carlo_forecast">
<a class="viewcode-back" href="../api_reference.html#monte_carlo_sim.MonteCarloForecaster.monte_carlo_forecast">[docs]</a>
    <span class="k">def</span> <span class="nf">monte_carlo_forecast</span><span class="p">(</span>   <span class="bp">self</span><span class="p">,</span> 
                                <span class="n">x_test</span><span class="p">,</span> 
                                <span class="n">num_days_to_predict</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> 
                                <span class="n">num_iterations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> 
                                <span class="n">base_temp</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
                                <span class="n">decay_factor</span><span class="o">=</span><span class="mf">0.995</span><span class="p">,</span> 
                                <span class="n">min_temp</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> 
                                <span class="n">confidence_levels</span><span class="o">=</span><span class="p">[</span><span class="mf">0.68</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">]</span>
                            <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enhanced Monte Carlo simulation for price forecasting with adaptive noise and multiple confidence intervals.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x_test : torch.Tensor</span>
<span class="sd">            Input test data tensor containing feature sequences.</span>
<span class="sd">        num_days_to_predict : int, default=100</span>
<span class="sd">            Number of days to forecast into the future.</span>
<span class="sd">        num_iterations : int, default=1000</span>
<span class="sd">            Number of Monte Carlo simulations to run.</span>
<span class="sd">        base_temp : float, default=0.1</span>
<span class="sd">            Initial temperature for noise generation.</span>
<span class="sd">        decay_factor : float, default=0.995</span>
<span class="sd">            Factor to decay temperature over time (0-1).</span>
<span class="sd">        min_temp : float, default=0.01</span>
<span class="sd">            Minimum temperature floor for noise generation.</span>
<span class="sd">        confidence_levels : list of float, default=[0.68, 0.95]</span>
<span class="sd">            List of confidence levels to calculate (e.g., [0.68, 0.95] for 1σ and 2σ).</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame</span>
<span class="sd">            DataFrame containing forecast results with columns:</span>
<span class="sd">            - Date : Forecast dates</span>
<span class="sd">            - Mean_Prediction : Average prediction for each date</span>
<span class="sd">            - Std_Prediction : Standard deviation of predictions</span>
<span class="sd">            - Confidence_Interval_X.XX_lower : Lower bound for each confidence level</span>
<span class="sd">            - Confidence_Interval_X.XX_upper : Upper bound for each confidence level</span>
<span class="sd">            </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method implements a sophisticated Monte Carlo approach to time series</span>
<span class="sd">        forecasting by:</span>
<span class="sd">        </span>
<span class="sd">        1. Running multiple simulations with randomized noise</span>
<span class="sd">        2. Using adaptive noise levels based on recent prediction variance</span>
<span class="sd">        3. Calculating multiple confidence intervals for uncertainty quantification</span>
<span class="sd">        4. Converting scaled predictions back to the original price scale</span>
<span class="sd">        </span>
<span class="sd">        The method maintains seed values for reproducibility(not that pytorch is allowing reproducability with CUDA for performance reasons if you don&#39;t have a b100).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
        
        <span class="n">seq_length</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">num_features</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="n">predicted_prices_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_iterations</span><span class="p">,</span> <span class="n">num_days_to_predict</span><span class="p">))</span>
        
        <span class="c1"># Calculate percentiles for each confidence level</span>
        <span class="n">percentiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">conf_level</span> <span class="ow">in</span> <span class="n">confidence_levels</span><span class="p">:</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">conf_level</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">conf_level</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">percentiles</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">])</span>
        
        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_iterations</span><span class="p">):</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
            <span class="n">predicted_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_days_to_predict</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">last_sequence</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">last_known_features</span> <span class="o">=</span> <span class="n">last_sequence</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                
                <span class="c1"># Track recent predictions for adaptive noise</span>
                <span class="n">recent_predictions</span> <span class="o">=</span> <span class="p">[]</span>
                
                <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_days_to_predict</span><span class="p">):</span>
                    <span class="c1"># Adaptive temperature based on prediction history</span>
                    <span class="n">dynamic_temp</span> <span class="o">=</span> <span class="n">base_temp</span> <span class="o">+</span> <span class="n">prediction_variance</span><span class="p">(</span><span class="n">predicted_prices</span><span class="p">[:</span><span class="n">day</span><span class="p">])</span>
                    
                    <span class="c1"># Generate prediction with noise</span>
                    <span class="n">next_day_prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">last_sequence</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                    <span class="n">noise</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dynamic_temp</span><span class="p">))</span>
                    <span class="n">next_day_prediction</span> <span class="o">+=</span> <span class="n">noise</span>
                    
                    <span class="n">predicted_prices</span><span class="p">[</span><span class="n">day</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_day_prediction</span>
                    <span class="n">recent_predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_day_prediction</span><span class="p">)</span>
                    
                    <span class="c1"># Update sequence for next prediction</span>
                    <span class="n">next_day_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_features</span><span class="p">)</span>
                    <span class="n">next_day_features</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_known_features</span>
                    <span class="n">next_day_features</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_day_prediction</span>
                    
                    <span class="n">next_day_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">next_day_features</span><span class="p">,</span>
                                                <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                                                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    
                    <span class="n">last_sequence</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span>
                        <span class="n">last_sequence</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:],</span>
                        <span class="n">next_day_tensor</span>
                    <span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                
                <span class="c1"># Transform predictions back to original scale</span>
                <span class="n">full_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">predicted_prices</span><span class="p">),</span> <span class="n">num_features</span><span class="p">))</span>
                <span class="n">full_features</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">predicted_prices</span>
                <span class="n">predicted_prices_all</span><span class="p">[</span><span class="n">seed</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">full_features</span><span class="p">)[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processed start index </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">num_iterations</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="c1"># Calculate statistics</span>
        <span class="n">mean_predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">predicted_prices_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">std_predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">predicted_prices_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">confidence_intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">predicted_prices_all</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Generate dates for forecast period</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2024-10-23&#39;</span><span class="p">)</span>
        <span class="n">remaining_days</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">num_days_to_predict</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
        
        <span class="c1"># Create results DataFrame</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Date&#39;</span><span class="p">:</span> <span class="n">remaining_days</span><span class="p">,</span>
                <span class="s1">&#39;Mean_Prediction&#39;</span><span class="p">:</span> <span class="n">mean_predictions</span><span class="p">,</span>
                <span class="s1">&#39;Std_Prediction&#39;</span><span class="p">:</span> <span class="n">std_predictions</span><span class="p">}</span>
        
        <span class="c1"># Add confidence intervals to results</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">conf_level</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">confidence_levels</span><span class="p">):</span>
            <span class="n">lower_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="n">upper_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">results</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Confidence_Interval_</span><span class="si">{</span><span class="n">conf_level</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">confidence_intervals</span><span class="p">[</span><span class="n">lower_idx</span><span class="p">]</span>
            <span class="n">results</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Confidence_Interval_</span><span class="si">{</span><span class="n">conf_level</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">confidence_intervals</span><span class="p">[</span><span class="n">upper_idx</span><span class="p">]</span>
        
        <span class="n">remaining_days_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remaining_days_data</span> <span class="o">=</span> <span class="n">remaining_days_data</span>
        
        <span class="k">return</span> <span class="n">remaining_days_data</span></div>



<div class="viewcode-block" id="MonteCarloForecaster.monte_carlo_backtesting">
<a class="viewcode-back" href="../api_reference.html#monte_carlo_sim.MonteCarloForecaster.monte_carlo_backtesting">[docs]</a>
    <span class="k">def</span> <span class="nf">monte_carlo_backtesting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                              <span class="n">test_data</span><span class="p">,</span> 
                              <span class="n">x_test</span><span class="p">,</span> 
                              <span class="n">forecast_horizon</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> 
                              <span class="n">num_simulations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> 
                              <span class="n">num_start_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                              <span class="n">base_temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> 
                              <span class="n">temperature_decay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.995</span><span class="p">,</span> 
                              <span class="n">min_temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                              <span class="n">confidence_levels</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.68</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">]</span>
                              <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform enhanced Monte Carlo backtesting with adaptive noise and confidence intervals.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_data : pandas.DataFrame</span>
<span class="sd">            DataFrame containing test data with &#39;Price&#39; and feature columns.</span>
<span class="sd">        x_test : torch.Tensor</span>
<span class="sd">            Tensor of preprocessed test data sequences.</span>
<span class="sd">        forecast_horizon : int, default=20</span>
<span class="sd">            Number of days ahead to forecast for each simulation.</span>
<span class="sd">        num_simulations : int, default=1000</span>
<span class="sd">            Number of Monte Carlo simulations to run per starting point.</span>
<span class="sd">            Minimum value is 30 for statistical significance.</span>
<span class="sd">        num_start_points : int, default=100</span>
<span class="sd">            Number of different starting points in the test set.</span>
<span class="sd">            Minimum value is 10 for statistical significance.</span>
<span class="sd">        base_temperature : float, default=0.1</span>
<span class="sd">            Initial temperature for noise generation.</span>
<span class="sd">        temperature_decay : float, default=0.995</span>
<span class="sd">            Factor to decay temperature over prediction horizon.</span>
<span class="sd">        min_temperature : float, default=0.01</span>
<span class="sd">            Minimum temperature floor for noise generation.</span>
<span class="sd">        confidence_levels : list of float, default=[0.68, 0.95]</span>
<span class="sd">            Confidence levels for interval calculation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary containing backtesting results for each start point:</span>
<span class="sd">            - predictions : numpy.ndarray</span>
<span class="sd">                Array of shape (num_iterations, num_days_to_predict)</span>
<span class="sd">            - mean : numpy.ndarray</span>
<span class="sd">                Mean prediction for each day</span>
<span class="sd">            - std : numpy.ndarray</span>
<span class="sd">                Standard deviation of predictions</span>
<span class="sd">            - start_date : datetime</span>
<span class="sd">                Starting date for this forecast</span>
<span class="sd">            - confidence_intervals : dict</span>
<span class="sd">                Confidence intervals at specified levels</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Statistical Requirements:</span>
<span class="sd">        1. Minimum Sample Size:</span>
<span class="sd">           - At least 30 simulations per start point for reliable statistics</span>
<span class="sd">           - At least 10 start points for robust backtesting coverage</span>
<span class="sd">           - These minima ensure reliable confidence interval estimation</span>
<span class="sd">        </span>
<span class="sd">        2. Temperature Control:</span>
<span class="sd">           - Base temperature controls initial prediction uncertainty</span>
<span class="sd">           - Temperature decay reduces uncertainty over forecast horizon</span>
<span class="sd">           - Minimum temperature prevents unrealistic stability</span>
<span class="sd">        </span>
<span class="sd">        3. Implementation Details:</span>
<span class="sd">           - Uses adaptive noise based on prediction variance</span>
<span class="sd">           - Maintains temporal alignment with test data</span>
<span class="sd">           - Preserves random state for reproducibility</span>
<span class="sd">        </span>

<span class="sd">        Warnings</span>
<span class="sd">        --------</span>
<span class="sd">        - Long prediction horizons may accumulate errors</span>
<span class="sd">        - High num_iterations may impact performance</span>
<span class="sd">        - Confidence intervals assume normal distribution</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        monte_carlo_backtesting_plot : Function to visualize these results</span>
<span class="sd">        monte_carlo_backtesting_diagnostics_plot : Function for diagnostic analysis</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; forecaster = MonteCarloForecaster(model, device)</span>
<span class="sd">        &gt;&gt;&gt; results = forecaster.monte_carlo_backtesting(</span>
<span class="sd">        ...     test_data=test_data,</span>
<span class="sd">        ...     x_test=x_test,</span>
<span class="sd">        ...     num_days_to_predict=10,</span>
<span class="sd">        ...     num_iterations=500</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Mean prediction horizon: {len(results[0][&#39;mean&#39;])} days&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Input validation</span>
        <span class="k">if</span> <span class="n">num_simulations</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;num_simulations must be at least 30 for statistical significance&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_start_points</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;num_start_points must be at least 10 for statistical significance&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">forecast_horizon</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;forecast_horizon must be at least 1&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">confidence_levels</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;confidence_levels must be between 0 and 1&quot;</span><span class="p">)</span>
        
        <span class="c1"># Set seed for reproducibility</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
        
        <span class="c1"># Prepare data</span>
        <span class="n">feature_data</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">])</span>
        <span class="n">sequence_length</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">num_features</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="c1"># Calculate evenly distributed start indices in the test set</span>
        <span class="n">feature_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>
        <span class="n">start_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">feature_length</span> <span class="o">-</span> <span class="n">forecast_horizon</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> 
                                <span class="n">num_start_points</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_indices</span> <span class="o">=</span> <span class="n">start_indices</span>
        
        <span class="c1"># Calculate percentiles for each confidence level</span>
        <span class="n">percentiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">conf_level</span> <span class="ow">in</span> <span class="n">confidence_levels</span><span class="p">:</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">conf_level</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">conf_level</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">percentiles</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">])</span>
        
        <span class="c1"># Initialize dictionary to store results for each start point</span>
        <span class="n">backtesting_results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">start_idx</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_simulations</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="p">)),</span>
                <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;start_date&#39;</span><span class="p">:</span> <span class="n">feature_data</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start_idx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence_size</span><span class="p">],</span>
                <span class="s1">&#39;confidence_intervals&#39;</span><span class="p">:</span> <span class="kc">None</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">start_idx</span> <span class="ow">in</span> <span class="n">start_indices</span>
        <span class="p">}</span>
        
        <span class="c1"># Generate predictions for each start point</span>
        <span class="k">for</span> <span class="n">start_idx</span> <span class="ow">in</span> <span class="n">start_indices</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">simulation_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_simulations</span><span class="p">):</span>
                <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">simulation_idx</span><span class="p">)</span>
                <span class="n">predicted_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">forecast_horizon</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                    <span class="c1"># Use the sequence at the start index as initial input</span>
                    <span class="n">initial_sequence</span> <span class="o">=</span> <span class="n">x_test</span><span class="p">[</span><span class="n">start_idx</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                    <span class="n">current_sequence</span> <span class="o">=</span> <span class="n">initial_sequence</span>
                    <span class="n">last_known_features</span> <span class="o">=</span> <span class="n">current_sequence</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                    
                    <span class="c1"># Track recent predictions for adaptive noise</span>
                    <span class="n">recent_predictions</span> <span class="o">=</span> <span class="p">[]</span>
                    
                    <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">forecast_horizon</span><span class="p">):</span>
                        <span class="c1"># Adaptive temperature based on prediction history</span>
                        <span class="n">dynamic_temp</span> <span class="o">=</span> <span class="n">base_temperature</span> <span class="o">+</span> <span class="n">prediction_variance</span><span class="p">(</span><span class="n">predicted_prices</span><span class="p">[:</span><span class="n">day</span><span class="p">])</span>
                        
                        <span class="c1"># Generate prediction with noise</span>
                        <span class="n">next_day_prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">current_sequence</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                        <span class="n">noise</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dynamic_temp</span><span class="p">))</span>
                        <span class="n">next_day_prediction</span> <span class="o">+=</span> <span class="n">noise</span>
                        
                        <span class="n">predicted_prices</span><span class="p">[</span><span class="n">day</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_day_prediction</span>
                        <span class="n">recent_predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_day_prediction</span><span class="p">)</span>
                        
                        <span class="c1"># Update sequence for next prediction</span>
                        <span class="n">next_day_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_features</span><span class="p">)</span>
                        <span class="n">next_day_features</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_known_features</span>
                        <span class="n">next_day_features</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_day_prediction</span>
                        
                        <span class="n">next_day_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">next_day_features</span><span class="p">,</span>
                                                    <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                                                    <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        
                        <span class="n">current_sequence</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span>
                            <span class="n">current_sequence</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:],</span>
                            <span class="n">next_day_tensor</span>
                        <span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    
                    <span class="c1"># Transform predictions back to original scale</span>
                    <span class="n">full_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">predicted_prices</span><span class="p">),</span> <span class="n">num_features</span><span class="p">))</span>
                    <span class="n">full_features</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">predicted_prices</span>
                    <span class="n">backtesting_results</span><span class="p">[</span><span class="n">start_idx</span><span class="p">][</span><span class="s1">&#39;predictions&#39;</span><span class="p">][</span><span class="n">simulation_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">full_features</span><span class="p">)[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="p">)</span>
            
            <span class="c1"># Calculate statistics for this start point</span>
            <span class="n">predictions_all</span> <span class="o">=</span> <span class="n">backtesting_results</span><span class="p">[</span><span class="n">start_idx</span><span class="p">][</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
            <span class="n">backtesting_results</span><span class="p">[</span><span class="n">start_idx</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">predictions_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">backtesting_results</span><span class="p">[</span><span class="n">start_idx</span><span class="p">][</span><span class="s1">&#39;std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">predictions_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="c1"># Calculate confidence intervals</span>
            <span class="n">confidence_intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">predictions_all</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">backtesting_results</span><span class="p">[</span><span class="n">start_idx</span><span class="p">][</span><span class="s1">&#39;confidence_intervals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">conf_level</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;lower&#39;</span><span class="p">:</span> <span class="n">confidence_intervals</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">],</span>
                    <span class="s1">&#39;upper&#39;</span><span class="p">:</span> <span class="n">confidence_intervals</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">conf_level</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">confidence_levels</span><span class="p">)</span>
            <span class="p">}</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processed start index </span><span class="si">{</span><span class="n">start_idx</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">start_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">backtesting_results</span></div>


<div class="viewcode-block" id="MonteCarloForecaster.monte_carlo_forecast_plot">
<a class="viewcode-back" href="../api_reference.html#monte_carlo_sim.MonteCarloForecaster.monte_carlo_forecast_plot">[docs]</a>
    <span class="k">def</span> <span class="nf">monte_carlo_forecast_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                <span class="n">remaining_days_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                                <span class="n">predictions</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                                <span class="n">test_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                                <span class="n">DateMax</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                                <span class="n">confidence_colors</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">price_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Price&#39;</span><span class="p">,</span>
                                <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Price Forecast with Confidence Intervals&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enhanced plotting function for forecasting results with flexible confidence intervals.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        remaining_days_data : pandas.DataFrame</span>
<span class="sd">            DataFrame containing future predictions and confidence intervals.</span>
<span class="sd">        predictions : pandas.DataFrame</span>
<span class="sd">            DataFrame containing model predictions for historical data.</span>
<span class="sd">        test_data : pandas.DataFrame</span>
<span class="sd">            Original test dataset containing actual price values.</span>
<span class="sd">        DateMax : int, default=100</span>
<span class="sd">            Maximum number of future dates to plot.</span>
<span class="sd">        confidence_colors : list of str, optional</span>
<span class="sd">            List of colors for confidence intervals. Defaults to red-based palette.</span>
<span class="sd">        price_column : str, default=&#39;Price&#39;</span>
<span class="sd">            Name of the price column in test_data.</span>
<span class="sd">        title : str, default=&#39;Price Forecast with Confidence Intervals&#39;</span>
<span class="sd">            Plot title.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            Displays the plot using matplotlib&#39;s pyplot.</span>
<span class="sd">            </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This function creates a comprehensive visualization that includes:</span>
<span class="sd">        </span>
<span class="sd">        1. Historical actual prices</span>
<span class="sd">        2. Historical model predictions</span>
<span class="sd">        3. Future forecasted prices with multiple confidence intervals</span>
<span class="sd">        4. Historical mean price reference line</span>
<span class="sd">        </span>
<span class="sd">        The visualization employs a customized color scheme for clarity and uses</span>
<span class="sd">        transparent confidence intervals to show prediction uncertainty. The function</span>
<span class="sd">        handles both date-indexed and date-columned DataFrames appropriately.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set style for better visualization</span>
        <span class="c1"># plt.style.use(&#39;whitegrid&#39;)</span>
        
        <span class="c1"># Default color scheme for confidence intervals</span>
        <span class="k">if</span> <span class="n">confidence_colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">confidence_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#ffcccc&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff9999&#39;</span><span class="p">]</span>  <span class="c1"># Light to darker red</span>
        
        <span class="c1"># Get dates - handle both cases where Date might be in columns or index</span>
        <span class="k">if</span> <span class="s1">&#39;Date&#39;</span> <span class="ow">in</span> <span class="n">test_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">dates</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">test_data</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">dates</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span>
        
        <span class="c1"># Extract price data</span>
        <span class="n">y_test_df</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">price_column</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_size</span><span class="p">:]</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_size</span><span class="p">:]</span>
        
        <span class="c1"># Create figure with specified size</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        
        <span class="c1"># Find confidence interval columns</span>
        <span class="n">ci_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">remaining_days_data</span><span class="o">.</span><span class="n">columns</span> 
                    <span class="k">if</span> <span class="s1">&#39;Confidence_Interval&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]</span>
        <span class="n">confidence_levels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">ci_columns</span> 
            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span>
        <span class="p">])),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Plot confidence intervals from widest to narrowest</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">conf_level</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">confidence_levels</span><span class="p">):</span>
            <span class="n">lower_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Confidence_Interval_</span><span class="si">{</span><span class="n">conf_level</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">_lower&#39;</span>
            <span class="n">upper_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Confidence_Interval_</span><span class="si">{</span><span class="n">conf_level</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">_upper&#39;</span>
            
            <span class="k">if</span> <span class="n">lower_col</span> <span class="ow">in</span> <span class="n">remaining_days_data</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">upper_col</span> <span class="ow">in</span> <span class="n">remaining_days_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                    <span class="n">remaining_days_data</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">DateMax</span><span class="p">],</span>
                    <span class="n">remaining_days_data</span><span class="p">[</span><span class="n">lower_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">DateMax</span><span class="p">],</span>
                    <span class="n">remaining_days_data</span><span class="p">[</span><span class="n">upper_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">DateMax</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">confidence_colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">confidence_colors</span><span class="p">)],</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">conf_level</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">% Confidence Interval&#39;</span>
                <span class="p">)</span>
        
        <span class="c1"># Plot historical and predicted data</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">y_test_df</span><span class="p">,</span> 
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#2E86C1&#39;</span><span class="p">,</span> 
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual Price&#39;</span><span class="p">,</span> 
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> 
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#28B463&#39;</span><span class="p">,</span> 
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predicted Price&#39;</span><span class="p">,</span> 
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        
        <span class="c1"># Plot mean future prediction</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">remaining_days_data</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">DateMax</span><span class="p">],</span>
                <span class="n">remaining_days_data</span><span class="p">[</span><span class="s1">&#39;Mean_Prediction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">DateMax</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#E74C3C&#39;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean Future Prediction&#39;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># Plot historical mean</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">y_test_df</span><span class="p">),</span> 
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#34495E&#39;</span><span class="p">,</span> 
                    <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> 
                    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Historical Mean&#39;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        
        <span class="c1"># Enhance plot appearance</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Price&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        
        <span class="c1"># Format axis</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1"># Add legend with custom styling</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> 
                        <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span>
                        <span class="n">borderaxespad</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                        <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Adjust layout</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        
        <span class="c1"># Show plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
        <span class="c1"># Close the figure to free memory</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="MonteCarloForecaster.monte_carlo_backtesting_plot">
<a class="viewcode-back" href="../api_reference.html#monte_carlo_sim.MonteCarloForecaster.monte_carlo_backtesting_plot">[docs]</a>
    <span class="k">def</span> <span class="nf">monte_carlo_backtesting_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                  <span class="n">x_test</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                                  <span class="n">backtesting_results</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                                  <span class="n">test_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                                  <span class="n">forecast_horizon</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
                                  <span class="n">num_start_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                                  <span class="n">confidence_colors</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="n">price_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Price&#39;</span><span class="p">,</span>
                                  <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Price Backtesting with Confidence Intervals&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create comprehensive visualization of Monte Carlo backtesting results.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x_test : pandas.DataFrame</span>
<span class="sd">            Preprocessed test data used for predictions.</span>
<span class="sd">        backtesting_results : dict</span>
<span class="sd">            Dictionary containing Monte Carlo simulation results from backtesting.</span>
<span class="sd">        test_data : pandas.DataFrame</span>
<span class="sd">            Original test dataset with actual prices.</span>
<span class="sd">        forecast_horizon : int, default=20</span>
<span class="sd">            Number of days predicted in each forecast.</span>
<span class="sd">        num_start_points : int, default=100</span>
<span class="sd">            Number of forecast starting points used.</span>
<span class="sd">        confidence_colors : list of str, optional</span>
<span class="sd">            Colors for confidence interval bands. Defaults to red-based palette.</span>
<span class="sd">        price_column : str, default=&#39;Price&#39;</span>
<span class="sd">            Name of the price column in test_data.</span>
<span class="sd">        title : str, default=&#39;Price Backtesting with Confidence Intervals&#39;</span>
<span class="sd">            Plot title.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            Displays the plot using matplotlib&#39;s pyplot.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Design Decisions:</span>
<span class="sd">        1. Visual Layout:</span>
<span class="sd">           - Large figure size (15, 8) for detail visibility</span>
<span class="sd">           - Clear separation of actual vs predicted values</span>
<span class="sd">           - Multiple confidence intervals with transparency</span>
<span class="sd">        </span>
<span class="sd">        2. Visual Elements:</span>
<span class="sd">           - Rainbow color scheme for different forecast periods</span>
<span class="sd">           - Transparent confidence intervals (alpha=0.1)</span>
<span class="sd">           - Historical mean reference line</span>
<span class="sd">           - Clear date formatting and grid lines</span>
<span class="sd">        </span>
<span class="sd">        3. Plot Components:</span>
<span class="sd">           - Actual price line (blue)</span>
<span class="sd">           - Individual forecast lines (rainbow colors)</span>
<span class="sd">           - Confidence intervals (semi-transparent)</span>
<span class="sd">           - Historical mean (dotted gray)</span>
<span class="sd">        </span>
<span class="sd">        4. Layout Considerations:</span>
<span class="sd">           - Large figure size (15x8) for detail visibility</span>
<span class="sd">           - Rotated x-axis labels for readability</span>
<span class="sd">           - Legend positioned outside plot</span>
<span class="sd">           - Grid lines for value reference</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Input validation</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">backtesting_results</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;backtesting_results cannot be empty&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">forecast_horizon</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;forecast_horizon must be at least 1&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_start_points</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;num_start_points must be at least 10 for statistical significance&quot;</span><span class="p">)</span>
        
        <span class="c1"># Default color scheme for confidence intervals</span>
        <span class="k">if</span> <span class="n">confidence_colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">confidence_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#ffcccc&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff9999&#39;</span><span class="p">]</span>  <span class="c1"># Light to darker red</span>
        
        <span class="c1"># Prepare data</span>
        <span class="n">feature_data</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">price_column</span><span class="p">])</span>
        <span class="n">actual_prices</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">price_column</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_size</span><span class="p">:]</span>
        
        <span class="c1"># Get dates - handle both cases where Date might be in columns or index</span>
        <span class="k">if</span> <span class="s1">&#39;Date&#39;</span> <span class="ow">in</span> <span class="n">test_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">dates</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">test_data</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">dates</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span>
        
        <span class="n">dates</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_size</span><span class="p">:]</span>
        
        <span class="c1"># Create figure with specified size</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        
        <span class="c1"># Plot actual prices</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">actual_prices</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#2E86C1&#39;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual Price&#39;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># Get start indices from backtesting_results</span>
        <span class="n">start_indices</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">backtesting_results</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="c1"># Plot each forecast with confidence intervals</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">rainbow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_indices</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">start_idx</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">start_indices</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
            <span class="n">start_date</span> <span class="o">=</span> <span class="n">backtesting_results</span><span class="p">[</span><span class="n">start_idx</span><span class="p">][</span><span class="s1">&#39;start_date&#39;</span><span class="p">]</span>
            <span class="n">forecast_dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
                                        <span class="n">periods</span><span class="o">=</span><span class="n">forecast_horizon</span><span class="p">,</span>
                                        <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
            
            <span class="c1"># Plot mean prediction</span>
            <span class="c1">#TODO delete if changes worked</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            for conf_level, interval_data in forecast_results[start_idx][&#39;confidence_intervals&#39;].items():</span>
<span class="sd">                plt.fill_between(dates_forecast,</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">forecast_dates</span><span class="p">,</span>
                    <span class="n">backtesting_results</span><span class="p">[</span><span class="n">start_idx</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Forecast from </span><span class="si">{</span><span class="n">start_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            
            <span class="c1"># Plot confidence intervals</span>
            <span class="k">for</span> <span class="n">conf_level</span><span class="p">,</span> <span class="n">interval_data</span> <span class="ow">in</span> <span class="n">backtesting_results</span><span class="p">[</span><span class="n">start_idx</span><span class="p">][</span><span class="s1">&#39;confidence_intervals&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">forecast_dates</span><span class="p">,</span>
                                <span class="n">interval_data</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">],</span>
                                <span class="n">interval_data</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">],</span>
                                <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">conf_level</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">% CI (</span><span class="si">{</span><span class="n">start_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        
        <span class="c1"># Plot historical mean</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">actual_prices</span><span class="p">),</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#34495E&#39;</span><span class="p">,</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Historical Mean&#39;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        
        <span class="c1"># Enhance plot appearance</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Price&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        
        <span class="c1"># Format axis</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1">#TODO add a color bar for ledgend normal legends dont work here too many items</span>
        
        <span class="c1"># Adjust layout</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        
        <span class="c1"># Show plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
        <span class="c1"># Close the figure to free memory</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<span class="c1">#TODO Generalize to an arbitray target variable and date format</span>
<div class="viewcode-block" id="MonteCarloForecaster.monte_carlo_backtesting_diagnotsics_plot">
<a class="viewcode-back" href="../api_reference.html#monte_carlo_sim.MonteCarloForecaster.monte_carlo_backtesting_diagnotsics_plot">[docs]</a>
    <span class="k">def</span> <span class="nf">monte_carlo_backtesting_diagnotsics_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                                          <span class="n">forecast_results</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> 
                                          <span class="n">test_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate diagnostic plots for Monte Carlo backtesting analysis.</span>

<span class="sd">        This function creates a two-panel diagnostic visualization showing prediction</span>
<span class="sd">        accuracy and error distribution patterns across the backtesting period.</span>
<span class="sd">        Designed to help identify systematic biases and error patterns.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        forecast_results : dict</span>
<span class="sd">            Dictionary containing Monte Carlo simulation results from backtesting.</span>
<span class="sd">            Must include mean predictions and confidence intervals.</span>
<span class="sd">        test_data : pandas.DataFrame</span>
<span class="sd">            Original test dataset with actual prices in &#39;Price&#39; column.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            Displays the plot using matplotlib&#39;s pyplot.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Design Decisions:</span>
<span class="sd">        1. Plot Layout:</span>
<span class="sd">           - Two-panel vertical arrangement (12, 10)</span>
<span class="sd">           - Top panel: Temporal error patterns</span>
<span class="sd">           - Bottom panel: Error distribution analysis</span>
<span class="sd">        </span>
<span class="sd">        2. Diagnostic Metrics:</span>
<span class="sd">           - Day-wise prediction accuracy</span>
<span class="sd">           - Error distribution characteristics</span>
<span class="sd">           - Systematic bias indicators</span>
<span class="sd">        </span>
<span class="sd">        3. Visual Elements:</span>
<span class="sd">           - Clear color coding for error types</span>
<span class="sd">           - Reference lines for perfect prediction</span>
<span class="sd">           - Confidence bands for uncertainty</span>
<span class="sd">        </span>
<span class="sd">        4. Analysis Features:</span>
<span class="sd">           - Temporal clustering of errors</span>
<span class="sd">           - Bias detection in predictions</span>
<span class="sd">           - Outlier identification</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        monte_carlo_backtesting : Function that generates the analyzed results</span>
<span class="sd">        monte_carlo_backtesting_plot : Main visualization of predictions</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; forecaster = MonteCarloForecaster(model, device)</span>
<span class="sd">        &gt;&gt;&gt; results = forecaster.monte_carlo_backtesting(test_data, x_test)</span>
<span class="sd">        &gt;&gt;&gt; forecaster.monte_carlo_backtesting_diagnotsics_plot(</span>
<span class="sd">        ...     forecast_results=results,</span>
<span class="sd">        ...     test_data=test_data</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; plt.show()  # If not in interactive mode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y_test_df</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_size</span><span class="p">:]</span>
        
        <span class="c1"># Create figure with two subplots</span>
        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        
        <span class="n">accuracy_plot_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">start_index</span> <span class="ow">in</span> <span class="n">forecast_results</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mean</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">forecast_results</span><span class="p">[</span><span class="n">start_index</span><span class="p">][</span><span class="s2">&quot;mean&quot;</span><span class="p">]):</span>
                <span class="n">accuracy_plot_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;day_out&quot;</span><span class="p">:</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;start_idx&quot;</span><span class="p">:</span> <span class="n">start_index</span><span class="p">,</span>
                    <span class="s2">&quot;valid_idx&quot;</span><span class="p">:</span> <span class="n">start_index</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="s2">&quot;end_idx&quot;</span><span class="p">:</span> <span class="n">start_index</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">forecast_results</span><span class="p">[</span><span class="n">start_index</span><span class="p">][</span><span class="s2">&quot;mean&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;means&quot;</span><span class="p">:</span> <span class="n">mean</span>
                <span class="p">})</span>

        <span class="n">accuracy_plot_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">accuracy_plot_data</span><span class="p">)</span>

        <span class="c1"># Initialize an empty list to collect the rows</span>
        <span class="n">y_test_filtered_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># &quot;day_out&quot; Using day_out from accuracy_plot_df instead of i+1</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">accuracy_plot_df</span><span class="p">[</span><span class="s2">&quot;valid_idx&quot;</span><span class="p">]):</span>
            <span class="n">y_test_filtered_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;Price&quot;</span><span class="p">:</span> <span class="n">y_test_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">val_idx</span><span class="p">],</span>
                <span class="s2">&quot;day_out&quot;</span><span class="p">:</span> <span class="n">accuracy_plot_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;day_out&quot;</span><span class="p">]</span> 
            <span class="p">})</span>

        <span class="c1"># Convert the list to a DataFrame</span>
        <span class="n">y_test_filtered</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">y_test_filtered_list</span><span class="p">)</span>

        <span class="c1"># Calculate RMSE for each day_out</span>
        <span class="n">day_out_rmse</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">accuracy_plot_df</span><span class="p">[</span><span class="s1">&#39;day_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
            <span class="n">day_mask</span> <span class="o">=</span> <span class="n">accuracy_plot_df</span><span class="p">[</span><span class="s1">&#39;day_out&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">day</span>
            <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span>
                <span class="n">y_test_filtered</span><span class="p">[</span><span class="n">day_mask</span><span class="p">][</span><span class="s1">&#39;Price&#39;</span><span class="p">],</span>
                <span class="n">accuracy_plot_df</span><span class="p">[</span><span class="n">day_mask</span><span class="p">][</span><span class="s1">&#39;means&#39;</span><span class="p">]</span>
            <span class="p">))</span>
            <span class="n">day_out_rmse</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;day_out&#39;</span><span class="p">:</span> <span class="n">day</span><span class="p">,</span>
                <span class="s1">&#39;rmse&#39;</span><span class="p">:</span> <span class="n">rmse</span>
            <span class="p">})</span>

        <span class="c1"># Convert to DataFrame for easy plotting</span>
        <span class="n">rmse_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">day_out_rmse</span><span class="p">)</span>

        <span class="c1"># Calculate percentage increase from day 1</span>
        <span class="n">first_day_rmse</span> <span class="o">=</span> <span class="n">rmse_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;rmse&#39;</span><span class="p">]</span>
        <span class="n">rmse_df</span><span class="p">[</span><span class="s1">&#39;pct_increase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">rmse_df</span><span class="p">[</span><span class="s1">&#39;rmse&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">first_day_rmse</span><span class="p">)</span> <span class="o">/</span> <span class="n">first_day_rmse</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Plot 1: RMSE over time</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rmse_df</span><span class="p">[</span><span class="s1">&#39;day_out&#39;</span><span class="p">],</span> <span class="n">rmse_df</span><span class="p">[</span><span class="s1">&#39;rmse&#39;</span><span class="p">],</span> 
                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> 
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#2E86C1&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;RMSE&#39;</span><span class="p">)</span>

        <span class="c1"># Customize first plot</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Forecast Horizon (Days)&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;RMSE&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;RMSE vs Forecast Horizon&#39;</span><span class="p">)</span>

        <span class="c1"># Add value labels on the points</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rmse_df</span><span class="p">[</span><span class="s1">&#39;day_out&#39;</span><span class="p">],</span> <span class="n">rmse_df</span><span class="p">[</span><span class="s1">&#39;rmse&#39;</span><span class="p">]):</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> 
                        <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> 
                        <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset points&quot;</span><span class="p">,</span> 
                        <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> 
                        <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

        <span class="c1"># Plot 2: Percentage increase</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rmse_df</span><span class="p">[</span><span class="s1">&#39;day_out&#39;</span><span class="p">],</span> <span class="n">rmse_df</span><span class="p">[</span><span class="s1">&#39;pct_increase&#39;</span><span class="p">],</span> 
                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> 
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#E74C3C&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;% Increase&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">rmse_df</span><span class="p">[</span><span class="s1">&#39;day_out&#39;</span><span class="p">],</span> <span class="n">rmse_df</span><span class="p">[</span><span class="s1">&#39;pct_increase&#39;</span><span class="p">],</span> 
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#E74C3C&#39;</span><span class="p">)</span>

        <span class="c1"># Customize second plot</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Forecast Horizon (Days)&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Percentage Increase from Day 1 (%)&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Percentage Increase in RMSE from Day 1&#39;</span><span class="p">)</span>

        <span class="c1"># Add value labels on the points</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rmse_df</span><span class="p">[</span><span class="s1">&#39;day_out&#39;</span><span class="p">],</span> <span class="n">rmse_df</span><span class="p">[</span><span class="s1">&#39;pct_increase&#39;</span><span class="p">]):</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">y</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">,</span> 
                        <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> 
                        <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset points&quot;</span><span class="p">,</span> 
                        <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> 
                        <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

        <span class="c1"># Adjust layout</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

        
<div class="viewcode-block" id="MonteCarloForecaster.monte_carlo_backtesting_pred_true_plot">
<a class="viewcode-back" href="../api_reference.html#monte_carlo_sim.MonteCarloForecaster.monte_carlo_backtesting_pred_true_plot">[docs]</a>
    <span class="k">def</span> <span class="nf">monte_carlo_backtesting_pred_true_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                                            <span class="n">forecast_results</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> 
                                            <span class="n">test_data</span> <span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate scatter plot comparing actual vs predicted prices from Monte Carlo backtesting.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        forecast_results : dict</span>
<span class="sd">            Dictionary containing Monte Carlo simulation results from backtesting.</span>
<span class="sd">            Must contain mean predictions for each forecast start point.</span>
<span class="sd">        test_data : pandas.DataFrame</span>
<span class="sd">            Original test dataset with actual prices in &#39;Price&#39; column.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            Displays the scatter plot using matplotlib&#39;s pyplot.</span>
<span class="sd">            </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This function creates a scatter plot visualization that:</span>
<span class="sd">        </span>
<span class="sd">        1. Compares actual prices against predicted prices</span>
<span class="sd">        2. Color-codes points by forecast horizon (days out)</span>
<span class="sd">        3. Includes a perfect prediction reference line</span>
<span class="sd">        4. Uses a color gradient to show how prediction accuracy changes with forecast distance</span>
<span class="sd">        </span>
<span class="sd">        The plot helps identify systematic biases in the model predictions and visualize</span>
<span class="sd">        how prediction accuracy varies across different price levels and forecast horizons.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y_test_df</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_size</span><span class="p">:]</span>
        
        <span class="n">accuracy_plot_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">start_index</span> <span class="ow">in</span> <span class="n">forecast_results</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mean</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">forecast_results</span><span class="p">[</span><span class="n">start_index</span><span class="p">][</span><span class="s2">&quot;mean&quot;</span><span class="p">]):</span>
                <span class="n">accuracy_plot_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;day_out&quot;</span><span class="p">:</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;start_idx&quot;</span><span class="p">:</span> <span class="n">start_index</span><span class="p">,</span>
                    <span class="s2">&quot;valid_idx&quot;</span><span class="p">:</span> <span class="n">start_index</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                    <span class="s2">&quot;end_idx&quot;</span><span class="p">:</span> <span class="n">start_index</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">forecast_results</span><span class="p">[</span><span class="n">start_index</span><span class="p">][</span><span class="s2">&quot;mean&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;means&quot;</span><span class="p">:</span> <span class="n">mean</span>
                <span class="p">})</span>

        <span class="n">accuracy_plot_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">accuracy_plot_data</span><span class="p">)</span>
        
        <span class="c1"># Initialize an empty list to collect the rows</span>
        <span class="n">y_test_filtered_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># &quot;day_out&quot; Using day_out from accuracy_plot_df instead of i+1</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">accuracy_plot_df</span><span class="p">[</span><span class="s2">&quot;valid_idx&quot;</span><span class="p">]):</span>
            <span class="n">y_test_filtered_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;Price&quot;</span><span class="p">:</span> <span class="n">y_test_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">val_idx</span><span class="p">],</span>
                <span class="s2">&quot;day_out&quot;</span><span class="p">:</span> <span class="n">accuracy_plot_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;day_out&quot;</span><span class="p">]</span> 
            <span class="p">})</span>

        <span class="c1"># Convert the list to a DataFrame</span>
        <span class="n">y_test_filtered</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">y_test_filtered_list</span><span class="p">)</span>
        
        <span class="c1"># Normalize &#39;day_out&#39; for colormap</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">accuracy_plot_df</span><span class="p">[</span><span class="s1">&#39;day_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">accuracy_plot_df</span><span class="p">[</span><span class="s1">&#39;day_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">viridis</span>  

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

        <span class="c1"># Scatter plot with color based on &#39;day_out&#39;</span>
        <span class="n">scatter</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">y_test_filtered</span><span class="p">[</span><span class="s2">&quot;Price&quot;</span><span class="p">],</span> 
            <span class="n">accuracy_plot_df</span><span class="p">[</span><span class="s1">&#39;means&#39;</span><span class="p">],</span> 
            <span class="n">c</span><span class="o">=</span><span class="n">accuracy_plot_df</span><span class="p">[</span><span class="s1">&#39;day_out&#39;</span><span class="p">],</span> 
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> 
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual vs. Predicted&#39;</span>
        <span class="p">)</span>

        <span class="c1"># Plot perfect prediction line</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">[</span><span class="n">y_test_filtered</span><span class="p">[</span><span class="s2">&quot;Price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_test_filtered</span><span class="p">[</span><span class="s2">&quot;Price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> 
            <span class="p">[</span><span class="n">y_test_filtered</span><span class="p">[</span><span class="s2">&quot;Price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_test_filtered</span><span class="p">[</span><span class="s2">&quot;Price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> 
            <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Perfect Prediction&#39;</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Actual Price&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Predicted Price&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Actual vs. Predicted Prices&#39;</span><span class="p">)</span>

        <span class="c1"># Add colorbar to indicate days out</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Days Out&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
</div>

    
    
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CoffeeGPT 1.5.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">monte_carlo_sim</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2025, John Hohman.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    </div>
  </body>
</html>